<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>منازل الأعداد</title>
<style>
  :root{
    --bg:#f7f7fb; --ink:#1b1b1f; --muted:#7a7a85; --card:#ffffff; --shadow:0 6px 18px rgba(0,0,0,.08);
    --units:#2fbf71;      /* الآحاد */
    --thousands:#3c83f6;  /* الألوف */
    --millions:#8b5cf6;   /* الملايين */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic UI", "Noto Sans Arabic", Arial, sans-serif;}

  /* الشريط العلوي */
  .topbar{
    position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff,rgba(255,255,255,.94));
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    padding:10px 12px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap
  }
  .big{font-weight:800;letter-spacing:.5px;font-size:clamp(28px,7vw,56px);line-height:1}
  .hint{font-size:12px;color:var(--muted);padding-inline:8px;padding-block:4px;border-radius:999px;background:#f0f0f4}
  .modegroup{display:flex;gap:6px;margin-inline-start:auto}
  .modegroup button,.reset{
    border:0;border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer;background:#ececf6;color:#2d2d33;
    box-shadow:inset 0 -2px 0 rgba(0,0,0,.05)
  }
  .modegroup button.active{background:#1f2937;color:#fff}
  .target-pill{
    display:inline-flex;align-items:center;gap:6px;background:#ffecc7;color:#8a4b00;border-radius:999px;padding:6px 10px;
    box-shadow:inset 0 -2px 0 rgba(0,0,0,.06)
  }
  .target-pill .close{margin-inline-start:4px;border:0;background:transparent;cursor:pointer;font-size:16px;line-height:1}

  /* اللوح: scroller LTR + row-reverse => الآحاد تظهر يمينًا على الهاتف */
  .board-wrap{padding:14px}
  .board{
    direction:ltr;
    display:flex; flex-direction:row-reverse;
    gap:12px; align-items:stretch;
    overflow-x:auto; overflow-y:visible;
    -webkit-overflow-scrolling:touch;
    overscroll-behavior-x:contain;
    scroll-snap-type:x mandatory; padding-bottom:8px; flex-wrap:nowrap; width:100%;
  }

  /* بطاقة وعاء */
  .bowl-card{
    flex:0 0 auto; width: clamp(170px, 22vw, 220px);
    background:var(--card); border-radius:18px; box-shadow:var(--shadow); padding:12px;
    display:flex; flex-direction:column; gap:10px; position:relative; scroll-snap-align:start; isolation:isolate;
  }
  .cap{
    position:absolute; inset-inline:10px 10px; top:8px; height:28px; border-radius:999px;
    display:flex; align-items:center; justify-content:center; gap:6px; font-size:12px; font-weight:700; color:#fff;
    pointer-events:none;
  }
  .cap .dot{width:10px;height:10px;border-radius:50%;background:#fff;opacity:.9}

  /* ألوان */
  .bowl-card.units{--col:var(--units)}
  .bowl-card.thousands{--col:var(--thousands)}
  .bowl-card.millions{--col:var(--millions)}
  .bowl-card{outline:2px solid rgba(0,0,0,.04); background:linear-gradient(180deg, rgba(255,255,255,1), color-mix(in srgb, var(--col) 10%, #fff));}
  .cap{background: color-mix(in srgb, var(--col) 90%, #000)}

  .b-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:30px}
  .b-head .mini{font-size:13px;color:#1f2430;font-weight:700}
  .b-buttons{display:flex;gap:8px}
  .b-buttons button{
    border:0;border-radius:12px;padding:10px 14px;min-width:52px;font-size:20px;font-weight:800;cursor:pointer;
    background:#ffffff;box-shadow:var(--shadow);touch-action:manipulation
  }
  .b-buttons button:active{transform:translateY(1px)}

  .grid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:8px;flex:1;align-content:start;min-height:100px
  }
  .ball{
    width:clamp(18px,5vw,26px);aspect-ratio:1;border-radius:999px;background:var(--col);
    filter:drop-shadow(0 2px 2px rgba(0,0,0,.15)); transform:scale(0); animation:pop .15s forwards
  }

  .deny{animation:shake .28s linear}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
  @keyframes pop{to{transform:scale(1)}}

  /* لوحة الهدف */
  .overlay{position:fixed;inset:0;background:rgba(0,0,25,.25);display:none;place-items:center;z-index:20;backdrop-filter:saturate(1.2) blur(1.5px)}
  .overlay.show{display:grid}
  .keypad{width:min(720px,92vw);background:#fff;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,.18);padding:16px;display:flex;flex-direction:column;gap:12px}
  .goal-display{font-weight:800;font-size:clamp(24px,6vw,40px);padding:10px 14px;border-radius:14px;background:#f4f4fb;display:flex;justify-content:space-between;align-items:center}
  .keys{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .keys button{border:0;border-radius:14px;background:#161823;color:#fff;box-shadow:inset 0 -2px 0 rgba(0,0,0,.3);padding:16px 10px;font-size:20px;font-weight:800;cursor:pointer}
  .keys button.alt{background:#e7e7f3;color:#1f2937;font-weight:700}
  .keys button.ok{background:#22c55e}
  .keys button.del{background:#ef4444}
  .keys button.exit{background:#334155;color:#fff}
  .keys button:active{transform:translateY(1px)}
  .kbd-hint{font-size:12px;color:var(--muted);text-align:center;margin-top:-2px}

  /* كانفس القصاصات */
  #confetti{position:fixed;inset:0;pointer-events:none;z-index:30}

  @media (hover:none){ .b-buttons button{min-height:56px} }
</style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <div class="topbar">
    <div class="big" id="bigNumber">٠</div>
    <span class="hint">كوِّن الرقم</span>

    <span class="target-pill" id="targetPill" style="display:none">
      <span>🎯</span><strong id="targetText">٠</strong>
      <button class="close" id="clearTarget" title="إزالة الهدف">✖</button>
    </span>

    <div class="modegroup" role="group" aria-label="الأوضاع">
      <button id="modeFree" class="active" title="وضع حر">حر</button>
      <button id="modeRandom" title="توليد هدف عشوائي">عشوائي</button>
      <button id="modeGoal" title="تحديد هدف يدوي">هدف</button>
    </div>
    <button class="reset" id="resetBtn" title="إعادة ضبط">↺ إعادة ضبط</button>
  </div>

  <div class="board-wrap">
    <div class="board" id="board">
      <!-- الآحاد (يمين) ← الألوف ← الملايين (يسار) -->
      <section class="bowl-card units" id="unitsAnchor" data-key="u1" data-mult="1">
        <div class="cap"><span class="dot"></span><span>الآحاد • آحاد</span></div>
        <div class="b-head"><span class="mini">آحاد</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card units" data-key="u10" data-mult="10">
        <div class="cap"><span class="dot"></span><span>الآحاد • عشرات</span></div>
        <div class="b-head"><span class="mini">عشرات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card units" data-key="u100" data-mult="100">
        <div class="cap"><span class="dot"></span><span>الآحاد • مئات</span></div>
        <div class="b-head"><span class="mini">مئات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>

      <section class="bowl-card thousands" data-key="t1" data-mult="1000">
        <div class="cap"><span class="dot"></span><span>الألوف • آحاد</span></div>
        <div class="b-head"><span class="mini">آحاد</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card thousands" data-key="t10" data-mult="10000">
        <div class="cap"><span class="dot"></span><span>الألوف • عشرات</span></div>
        <div class="b-head"><span class="mini">عشرات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card thousands" data-key="t100" data-mult="100000">
        <div class="cap"><span class="dot"></span><span>الألوف • مئات</span></div>
        <div class="b-head"><span class="mini">مئات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>

      <section class="bowl-card millions" data-key="m1" data-mult="1000000">
        <div class="cap"><span class="dot"></span><span>الملايين • آحاد</span></div>
        <div class="b-head"><span class="mini">آحاد</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card millions" data-key="m10" data-mult="10000000">
        <div class="cap"><span class="dot"></span><span>الملايين • عشرات</span></div>
        <div class="b-head"><span class="mini">عشرات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card millions" data-key="m100" data-mult="100000000">
        <div class="cap"><span class="dot"></span><span>الملايين • مئات</span></div>
        <div class="b-head"><span class="mini">مئات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
    </div>
  </div>

  <!-- لوحة هدف يدوي -->
  <div class="overlay" id="overlay">
    <div class="keypad" role="dialog" aria-label="ضبط الهدف">
      <div class="goal-display"><strong>🎯 الهدف</strong><span id="goalPreview">٠</span></div>
      <div class="keys" id="keys"></div>
      <div class="kbd-hint">أقصى طول ٩ خانات (حتى ٩٩٩،٩٩٩،٩٩٩)</div>
    </div>
  </div>

<script>
(() => {
  "use strict";
  /* ===== ثوابت متوافقة مع كل المتصفحات ===== */
  var MAX = 999999999;

  /* ===== أرقام عربية ===== */
  var arabicDigits = "٠١٢٣٤٥٦٧٨٩";
  function toArabicDigits(s){ return s.replace(/\d/g, function(d){ return arabicDigits[d]; }); }
  function formatArabic(n){
    var s = String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return toArabicDigits(s).replace(/,/g,"،");
  }

  /* ===== صوت (Web Audio) ===== */
  var audioCtx;
  function ensureAudio(){
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume();
    }catch(e){}
  }
  function beep(freq, dur, type, vol){
    freq = freq||600; dur = dur||0.08; type = type||"sine"; vol = vol||0.06;
    try{
      ensureAudio();
      var o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq; o.connect(g); g.connect(audioCtx.destination);
      var now = audioCtx.currentTime;
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(vol, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      o.start(now); o.stop(now + dur + 0.02);
    }catch(e){}
  }
  function chord(notes){
    notes = notes || [523,659,784,988];
    try{
      ensureAudio();
      var start = audioCtx.currentTime + 0.02;
      notes.forEach(function(f,i){
        var o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type="triangle"; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
        var t = start + i*0.03;
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.08, t+0.04);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.28);
        o.start(t); o.stop(t+0.32);
      });
    }catch(e){}
  }

  /* ===== الحالة ===== */
  var state = {u1:0,u10:0,u100:0, t1:0,t10:0,t100:0, m1:0,m10:0,m100:0};
  var cards = [].slice.call(document.querySelectorAll(".bowl-card"));
  var bigNumberEl = document.getElementById("bigNumber");

  function getValue(){
    return cards.reduce(function(acc, c){
      var key = c.getAttribute("data-key");
      var mult = +c.getAttribute("data-mult");
      return acc + (state[key]||0)*mult;
    },0);
  }

  function renderCard(c){
    var key = c.getAttribute("data-key");
    var grid = c.querySelector(".grid");
    grid.innerHTML = "";
    var count = state[key]||0;
    for(var i=0;i<count;i++){
      var ball = document.createElement("div");
      ball.className = "ball";
      grid.appendChild(ball);
    }
  }
  function renderAll(){
    cards.forEach(renderCard);
    var val = getValue();
    bigNumberEl.textContent = formatArabic(val);
    if (currentTarget != null) checkWin(val);
  }

  function deny(el){
    el.classList.remove("deny"); void el.offsetWidth; el.classList.add("deny");
    beep(160,0.08,"square",0.05); if (navigator.vibrate) navigator.vibrate(30);
  }

  cards.forEach(function(c){
    c.addEventListener("click", function(ev){
      var btn = ev.target.closest && ev.target.closest("button");
      if(!btn) return;
      var act = btn.getAttribute("data-act");
      var key = c.getAttribute("data-key");
      if (act === "plus"){
        if (state[key] >= 9){ deny(c); return; }
        state[key]++; renderCard(c); renderAll(); beep(700,0.06,"sine",0.06);
      } else {
        if (state[key] <= 0){ deny(c); return; }
        state[key]--; renderCard(c); renderAll(); beep(420,0.06,"sine",0.06);
      }
    });
  });

  /* ===== أوضاع ===== */
  var modeBtns = {
    free: document.getElementById("modeFree"),
    random: document.getElementById("modeRandom"),
    goal: document.getElementById("modeGoal")
  };
  var targetPill = document.getElementById("targetPill");
  var targetText = document.getElementById("targetText");
  var clearTargetBtn = document.getElementById("clearTarget");
  var resetBtn = document.getElementById("resetBtn");

  var mode = "free";
  var currentTarget = null;
  var lastWinValue = null;

  function setMode(m){
    mode = m;
    Object.values(modeBtns).forEach(function(b){ b.classList.remove("active"); });
    if (m==="free"){ modeBtns.free.classList.add("active"); hideTarget(); }
    if (m==="random"){ modeBtns.random.classList.add("active"); }
    if (m==="goal"){ modeBtns.goal.classList.add("active"); }
  }
  function showTarget(n){
    n = Math.max(0, Math.min(MAX, n|0));
    currentTarget = n;
    targetText.textContent = formatArabic(currentTarget);
    targetPill.style.display = "inline-flex";
  }
  function hideTarget(){ currentTarget = null; targetPill.style.display = "none"; }

  clearTargetBtn.addEventListener("click", function(){ hideTarget(); setMode("free"); renderAll(); });

  modeBtns.free.addEventListener("click", function(){ setMode("free"); });
  modeBtns.random.addEventListener("click", function(){
    setMode("random");
    var r = Math.floor(Math.random()*MAX)+1;
    showTarget(r); renderAll(); beep(520,0.08,"triangle",0.06);
  });

  /* ===== لوحة هدف يدوي ===== */
  var overlay = document.getElementById("overlay");
  var keysGrid = document.getElementById("keys");
  var goalPreview = document.getElementById("goalPreview");

  function buildKeypad(){
    keysGrid.innerHTML = "";
    function makeBtn(txt, cls, key){
      var b = document.createElement("button");
      b.textContent = txt; if (cls) b.className = cls; if (key) b.setAttribute("data-key", key);
      keysGrid.appendChild(b); return b;
    }
    var digits = ["٩","٨","٧","٦","٥","٤","٣","٢","١","٠"];
    digits.forEach(function(d){ makeBtn(d); });
    makeBtn("🗑️","alt del","clear");
    makeBtn("⌫","alt del","back");
    makeBtn("✔","ok","ok");
    makeBtn("✖","exit","exit");
    var spacer = document.createElement("div"); spacer.style.visibility="hidden"; keysGrid.appendChild(spacer);
  }

  var manualBuffer = "";
  function bufToNumber(){
    var map = {"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};
    var ascii = manualBuffer.replace(/[٠-٩]/g, function(ch){ return map[ch]; });
    var n = ascii.length ? parseInt(ascii,10) : 0;
    if (isNaN(n)) n = 0;
    return Math.min(MAX, n);
  }
  function updatePreview(){ goalPreview.textContent = formatArabic(bufToNumber()); }

  modeBtns.goal.addEventListener("click", function(){
    setMode("goal"); manualBuffer = ""; updatePreview(); overlay.classList.add("show"); beep(480,0.06,"sine",0.05);
  });
  overlay.addEventListener("click", function(e){ if (e.target === overlay){ overlay.classList.remove("show"); if(currentTarget==null) setMode("free"); }});
  keysGrid.addEventListener("click", function(e){
    var btn = e.target.closest && e.target.closest("button"); if(!btn) return;
    var k = btn.getAttribute("data-key") || btn.textContent.trim();
    ensureAudio();
    if (/^[٠-٩]$/.test(k)){
      if (manualBuffer.length >= 9) { deny(keysGrid); return; }
      manualBuffer += k; beep(620,0.05,"sine",0.05); updatePreview();
    } else if (k==="clear"){ manualBuffer=""; updatePreview(); beep(300,0.06,"triangle",0.05);
    } else if (k==="back"){ manualBuffer=manualBuffer.slice(0,-1); updatePreview(); beep(360,0.05,"triangle",0.05);
    } else if (k==="ok"){ var n = bufToNumber(); showTarget(n); overlay.classList.remove("show"); renderAll(); beep(520,0.08,"triangle",0.06);
    } else if (k==="exit"){ overlay.classList.remove("show"); if(currentTarget==null) setMode("free"); beep(220,0.05,"sine",0.04); }
  });

  /* ===== إعادة ضبط ===== */
  resetBtn.addEventListener("click", function(){
    Object.keys(state).forEach(function(k){ state[k]=0; });
    cards.forEach(renderCard); hideTarget(); setMode("free"); lastWinValue=null; renderAll(); beep(300,0.05,"triangle",0.06);
    scrollToUnits();
  });

  /* ===== فوز + قصاصات ===== */
  var canvas = document.getElementById("confetti"), ctx = canvas.getContext("2d");
  var confettiAnim = null, confettiParts = [];
  var colors = ["#2fbf71","#3c83f6","#8b5cf6","#ffd166","#06d6a0","#ef476f"];
  function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener("resize", resizeCanvas); resizeCanvas();

  function startConfetti(duration){
    duration = duration || 1800;
    confettiParts = Array.from({length:160}).map(function(){ return {
      x: Math.random()*canvas.width, y: -20 - Math.random()*80, r: 4 + Math.random()*6,
      s: 2 + Math.random()*3, a: 0.75 + Math.random()*0.25, c: colors[Math.floor(Math.random()*colors.length)], w: Math.random()*2*Math.PI
    };});
    var t0 = performance.now();
    function step(t){
      var dt = Math.min(32, t - (step.prev||t)); step.prev = t;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      confettiParts.forEach(function(p){
        p.y += p.s * (dt/16); p.x += Math.sin((t+p.w)/220) * 1.2;
        ctx.globalAlpha = p.a; ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      });
      if (t - t0 < duration){ confettiAnim = requestAnimationFrame(step); }
      else { ctx.clearRect(0,0,canvas.width,canvas.height); cancelAnimationFrame(confettiAnim); confettiAnim=null; }
    }
    cancelAnimationFrame(confettiAnim); confettiAnim = requestAnimationFrame(step);
  }

  function checkWin(val){
    if (currentTarget==null) return;
    if (val === currentTarget && lastWinValue !== val){
      lastWinValue = val; chord(); startConfetti(2000);
    }
  }

  /* ===== إظهار الآحاد يمينًا دائمًا ===== */
  var board = document.getElementById("board");
  function scrollToUnits(){
    requestAnimationFrame(function(){ requestAnimationFrame(function(){ board.scrollLeft = board.scrollWidth; }); });
  }

  /* ===== بدء ===== */
  var keys = document.getElementById("keys");
  function buildKeypadOnce(){ if (!keys.getAttribute("data-ready")){ keys.setAttribute("data-ready","1"); buildKeypad(); } }
  buildKeypadOnce();
  renderAll();
  addEventListener("pointerdown", ensureAudio, {once:true, passive:true});
  scrollToUnits();
  addEventListener("orientationchange", scrollToUnits, {passive:true});
  addEventListener("resize", scrollToUnits, {passive:true});
})();
</script>
</body>
</html>

