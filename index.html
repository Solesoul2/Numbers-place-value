<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>منازل الأعداد — صف أفقي واحد</title>
<style>
  :root{
    --bg:#f7f7fb; --ink:#1b1b1f; --muted:#7a7a85; --card:#ffffff; --shadow:0 6px 18px rgba(0,0,0,.08);
    --units:#2fbf71;      /* الآحاد */
    --thousands:#3c83f6;  /* الألوف */
    --millions:#8b5cf6;   /* الملايين */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic UI", "Noto Sans Arabic", Arial, sans-serif;}

  /* الشريط العلوي */
  .topbar{
    position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff,rgba(255,255,255,.94));
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    padding:10px 12px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap
  }
  .big{font-weight:800;letter-spacing:.5px;font-size:clamp(28px,7vw,56px);line-height:1}
  .hint{font-size:12px;color:var(--muted);padding-inline:8px;padding-block:4px;border-radius:999px;background:#f0f0f4}
  .modegroup{display:flex;gap:6px;margin-inline-start:auto}
  .modegroup button,.reset{
    border:0;border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer;background:#ececf6;color:#2d2d33;
    box-shadow:inset 0 -2px 0 rgba(0,0,0,.05)
  }
  .modegroup button.active{background:#1f2937;color:#fff}
  .target-pill{
    display:inline-flex;align-items:center;gap:6px;background:#ffecc7;color:#8a4b00;border-radius:999px;padding:6px 10px;
    box-shadow:inset 0 -2px 0 rgba(0,0,0,.06)
  }
  .target-pill .close{margin-inline-start:4px;border:0;background:transparent;cursor:pointer;font-size:16px;line-height:1}

  /* اللوح: scroller LTR + row-reverse => عرض آحاد يمين بدون مشاكل أندرويد */
  .board-wrap{padding:14px}
  .board{
    direction:ltr;                   /* مهم: نجعل التمرير بنمط LTR */
    display:flex; flex-direction:row-reverse; /* لكن الترتيب بصريًا يمين→يسار */
    gap:12px; align-items:stretch;
    overflow-x:auto; overflow-y:visible;
    -webkit-overflow-scrolling:touch;
    overscroll-behavior-x:contain;
    scroll-snap-type:x mandatory; padding-bottom:8px; flex-wrap:nowrap; width:100%;
  }

  /* بطاقة وعاء */
  .bowl-card{
    flex:0 0 auto; width: clamp(170px, 22vw, 220px);
    background:var(--card); border-radius:18px; box-shadow:var(--shadow); padding:12px;
    display:flex; flex-direction:column; gap:10px; position:relative; scroll-snap-align:start; isolation:isolate;
  }
  .cap{
    position:absolute; inset-inline:10px 10px; top:8px; height:28px; border-radius:999px;
    display:flex; align-items:center; justify-content:center; gap:6px; font-size:12px; font-weight:700; color:#fff;
    pointer-events:none;
  }
  .cap .dot{width:10px;height:10px;border-radius:50%;background:#fff;opacity:.9}

  /* ألوان */
  .bowl-card.units{--col:var(--units)}
  .bowl-card.thousands{--col:var(--thousands)}
  .bowl-card.millions{--col:var(--millions)}
  .bowl-card{outline:2px solid rgba(0,0,0,.04); background:linear-gradient(180deg, rgba(255,255,255,1), color-mix(in srgb, var(--col) 10%, #fff));}
  .cap{background: color-mix(in srgb, var(--col) 90%, #000)}

  .b-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:30px}
  .b-head .mini{font-size:13px;color:#1f2430;font-weight:700}
  .b-buttons{display:flex;gap:8px}
  .b-buttons button{
    border:0;border-radius:12px;padding:10px 14px;min-width:52px;font-size:20px;font-weight:800;cursor:pointer;
    background:#ffffff;box-shadow:var(--shadow);touch-action:manipulation
  }
  .b-buttons button:active{transform:translateY(1px)}

  .grid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:8px;flex:1;align-content:start;min-height:100px
  }
  .ball{
    width:clamp(18px,5vw,26px);aspect-ratio:1;border-radius:999px;background:var(--col);
    filter:drop-shadow(0 2px 2px rgba(0,0,0,.15)); transform:scale(0); animation:pop .15s forwards
  }

  .deny{animation:shake .28s linear}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
  @keyframes pop{to{transform:scale(1)}}

  /* لوحة الهدف */
  .overlay{position:fixed;inset:0;background:rgba(0,0,25,.25);display:none;place-items:center;z-index:20;backdrop-filter:saturate(1.2) blur(1.5px)}
  .overlay.show{display:grid}
  .keypad{width:min(720px,92vw);background:#fff;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,.18);padding:16px;display:flex;flex-direction:column;gap:12px}
  .goal-display{font-weight:800;font-size:clamp(24px,6vw,40px);padding:10px 14px;border-radius:14px;background:#f4f4fb;display:flex;justify-content:space-between;align-items:center}
  .keys{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .keys button{border:0;border-radius:14px;background:#161823;color:#fff;box-shadow:inset 0 -2px 0 rgba(0,0,0,.3);padding:16px 10px;font-size:20px;font-weight:800;cursor:pointer}
  .keys button.alt{background:#e7e7f3;color:#1f2937;font-weight:700}
  .keys button.ok{background:#22c55e}
  .keys button.del{background:#ef4444}
  .keys button.exit{background:#334155;color:#fff}
  .keys button:active{transform:translateY(1px)}
  .kbd-hint{font-size:12px;color:var(--muted);text-align:center;margin-top:-2px}

  /* كانفس القصاصات */
  #confetti{position:fixed;inset:0;pointer-events:none;z-index:30}

  @media (hover:none){ .b-buttons button{min-height:56px} }
</style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <div class="topbar">
    <div class="big" id="bigNumber">٠</div>
    <span class="hint">كوِّن الرقم</span>

    <span class="target-pill" id="targetPill" style="display:none">
      <span>🎯</span><strong id="targetText">٠</strong>
      <button class="close" id="clearTarget" title="إزالة الهدف">✖</button>
    </span>

    <div class="modegroup" role="group" aria-label="الأوضاع">
      <button id="modeFree" class="active" title="وضع حر">حر</button>
      <button id="modeRandom" title="توليد هدف عشوائي">عشوائي</button>
      <button id="modeGoal" title="تحديد هدف يدوي">هدف</button>
    </div>
    <button class="reset" id="resetBtn" title="إعادة ضبط">↺ إعادة ضبط</button>
  </div>

  <div class="board-wrap">
    <div class="board" id="board">
      <!-- الآحاد (يمين) ← الألوف ← الملايين (يسار) -->
      <section class="bowl-card units" id="unitsAnchor" data-key="u1" data-mult="1">
        <div class="cap"><span class="dot"></span><span>الآحاد • آحاد</span></div>
        <div class="b-head"><span class="mini">آحاد</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card units" data-key="u10" data-mult="10">
        <div class="cap"><span class="dot"></span><span>الآحاد • عشرات</span></div>
        <div class="b-head"><span class="mini">عشرات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card units" data-key="u100" data-mult="100">
        <div class="cap"><span class="dot"></span><span>الآحاد • مئات</span></div>
        <div class="b-head"><span class="mini">مئات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>

      <section class="bowl-card thousands" data-key="t1" data-mult="1000">
        <div class="cap"><span class="dot"></span><span>الألوف • آحاد</span></div>
        <div class="b-head"><span class="mini">آحاد</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card thousands" data-key="t10" data-mult="10000">
        <div class="cap"><span class="dot"></span><span>الألوف • عشرات</span></div>
        <div class="b-head"><span class="mini">عشرات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card thousands" data-key="t100" data-mult="100000">
        <div class="cap"><span class="dot"></span><span>الألوف • مئات</span></div>
        <div class="b-head"><span class="mini">مئات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>

      <section class="bowl-card millions" data-key="m1" data-mult="1000000">
        <div class="cap"><span class="dot"></span><span>الملايين • آحاد</span></div>
        <div class="b-head"><span class="mini">آحاد</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card millions" data-key="m10" data-mult="10000000">
        <div class="cap"><span class="dot"></span><span>الملايين • عشرات</span></div>
        <div class="b-head"><span class="mini">عشرات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
      <section class="bowl-card millions" data-key="m100" data-mult="100000000">
        <div class="cap"><span class="dot"></span><span>الملايين • مئات</span></div>
        <div class="b-head"><span class="mini">مئات</span>
          <div class="b-buttons"><button data-act="plus">＋</button><button data-act="minus">−</button></div>
        </div><div class="grid"></div>
      </section>
    </div>
  </div>

  <!-- لوحة هدف يدوي -->
  <div class="overlay" id="overlay">
    <div class="keypad" role="dialog" aria-label="ضبط الهدف">
      <div class="goal-display"><strong>🎯 الهدف</strong><span id="goalPreview">٠</span></div>
      <div class="keys" id="keys"></div>
      <div class="kbd-hint">أقصى طول ٩ خانات (حتى ٩٩٩،٩٩٩،٩٩٩)</div>
    </div>
  </div>

<script>
(() => {
  "use strict";
  /* ===== أرقام عربية ===== */
  const arabicDigits = "٠١٢٣٤٥٦٧٨٩";
  const toArabicDigits = s => s.replace(/\d/g, d => arabicDigits[d]);
  const formatArabic = n => {
    const s = n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return toArabicDigits(s).replace(/,/g, "،");
  };

  /* ===== صوت (Web Audio) ===== */
  let audioCtx;
  const ensureAudio = () => {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
  };
  const beep = (freq=600, dur=0.08, type="sine", vol=0.06) => {
    try{
      ensureAudio();
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq; o.connect(g); g.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(vol, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      o.start(now); o.stop(now + dur + 0.02);
    }catch{}
  };
  const chord = (notes=[523,659,784,988]) => {
    ensureAudio();
    const start = audioCtx.currentTime + 0.02;
    notes.forEach((f,i)=>{
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type="triangle"; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
      const t = start + i*0.03;
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.08, t+0.04);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.28);
      o.start(t); o.stop(t+0.32);
    });
  };

  /* ===== الحالة ===== */
  const state = {u1:0,u10:0,u100:0, t1:0,t10:0,t100:0, m1:0,m10:0,m100:0};
  const cards = [...document.querySelectorAll(".bowl-card")];
  const bigNumberEl = document.getElementById("bigNumber");

  const getValue = () => cards.reduce((acc, c)=>{
    const key = c.dataset.key, mult = +c.dataset.mult;
    return acc + (state[key]||0)*mult;
  },0);

  const renderCard = (c) => {
    const key = c.dataset.key;
    const grid = c.querySelector(".grid");
    grid.innerHTML = "";
    const count = state[key]||0;
    for(let i=0;i<count;i++){
      const ball = document.createElement("div");
      ball.className = "ball";
      grid.appendChild(ball);
    }
  };
  const renderAll = () => {
    cards.forEach(renderCard);
    const val = getValue();
    bigNumberEl.textContent = formatArabic(val);
    if (currentTarget != null) checkWin(val);
  };

  const deny = (el) => {
    el.classList.remove("deny"); void el.offsetWidth; el.classList.add("deny");
    beep(160,0.08,"square",0.05); if (navigator.vibrate) navigator.vibrate(30);
  };

  cards
